{% extends "base.html" %}
{% block title %}

{% endblock title %}
{% block style %}
<style>
  footer {
    display: none;
  }
</style>
{% endblock style %}
{% block body %}
<div class="container" style="margin-top:100px;">
  <section class="login-page">

    <!--Start login Form-->

    <div class="login-form-div" style="box-shadow: 0px 0px 10px 0px white;">
      <h4 class="mb40 text-center">Login to your Account</h4>
      <div class="form-block">
        <form id="contact-form" action="#">
          <div class="fieldsets row">
            <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

            <div class="col-md-12 form-group">
              <input id="login_email" type="email" placeholder="Email Address" required="true">
            </div>
            <div class="col-md-12 form-group"><input type="password" placeholder="password" id="login_password"
                required="true">
            </div>
          </div>
          <div class="fieldsets row mt20">
            <div class="col-md-6 form-group v-center">
              <button role="submit" class="lnk btn-main bg-btn" id="login_submit_button">Submit <span
                  class="circle"></span></button>
            </div>
            <div class="col-md-6 form-group v-center text-right"><a href="/forgot-password-mail-request/"
                class="psforgt">Forgot Password?</a> </div>
          </div>
          <hr class="mt30 mb30">
          <div class="text-center">
            <p class="mb20">or Login with:</p>
            <div style="cursor: pointer;
    width: 100%;
    display: flex
;
    justify-content: center;
    align-items: center;" id="googleSignInButton"></div>
          </div>
          <div style="margin:20px 10px;text-align:center;">don't have a account ? <a href="/signup/">Signup</a></div>
        </form>
      </div>
    </div>
  </section>
</div>
<!--End login Form-->

{% endblock body %}
{% block script %}
<script>
  let login_form = document.getElementById("contact-form");
  let login_email = document.getElementById("login_email");
  let login_password = document.getElementById("login_password");


  login_form.addEventListener("submit", async (e) => {
    e.preventDefault(); // Prevent default form submission behavior
    main_message.style.display = "none";

    // Prepare the data
    const data = {
      email: login_email.value,
      password: login_password.value
    };

    // Make the API call
    await fetch(`${window.location.origin}/api/login/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken
      },
      body: JSON.stringify(data)
    })
      .then((response) => response.json())
      .then((response) => {
        console.log("response", response);
        if (response.success === true) {
          message_image.src = "/static/images/checked.png";
          message_topic.style.color = "green";
          message_topic.innerHTML = "Success";

          message.innerHTML = "Login Successfully Done! Redirecting...";
          main_message.style.display = "flex";
          localStorage.setItem("kartik_website_access_token", response.token.access_token)
          localStorage.setItem("kartik_website_refresh_token", response.token.refresh_token)

          // Redirect after some time

          if (redirect_to) {
            setTimeout(() => {
              window.location.href = `/video-call/${redirect_to}`;
            }, 2000);
          }
          else {

            setTimeout(() => {
              window.location.href = "/";
            }, 2000);
          }
        } else {
          let errorMessage = response.message.email?.[0] ||
            response.message.password?.[0] ||
            response.message.non_field_errors?.[0] ||
            response.message || "An error occurred";
          message_image.src = "/static/images/remove.png";
          message_topic.innerHTML = "Error";
          message_topic.style.color = "red";
          message.innerHTML = errorMessage;
          main_message.style.display = "flex";
        }
      });
  });
</script>
{% endblock script %}